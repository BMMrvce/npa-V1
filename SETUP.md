# Setup — NPA2 (local development)

This file describes how to get the project running on a new machine. It covers both local (native) development and an easy Docker-based development setup.

## Prerequisites
- Git
- Node.js (recommended v18 or v20) and npm
- Deno (latest stable)
- Docker & Docker Compose (optional, for containerized setup)
- A Supabase project (or equivalent endpoints) with these keys:
  - `SUPABASE_URL`
  - `SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`

## Quick local setup (native)

1. Clone the repo and change directory:

```bash
git clone <repo-url> npa-V1
cd npa-V1
```

2. Create backend env file `backend/.env` with your Supabase credentials:

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=public-anon-key
SUPABASE_SERVICE_ROLE_KEY=service-role-key
```

3. Install frontend dependencies:

```bash
cd frontend
npm install
cd ..
```

4. Start backend and frontend (two terminals recommended):

Terminal A — Backend:

```bash
# export envs from backend/.env into your shell
export $(grep -v '^#' backend/.env | xargs)
cd backend
deno run --allow-net --allow-env --allow-read index.ts
```

Terminal B — Frontend:

```bash
cd frontend
npm run dev
# open http://localhost:5173
```

Optional (recommended): ensure frontend points to the same Supabase project as the backend.

Create `frontend/.env.local`:

```env
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=public-anon-key
```

If these are not set, frontend falls back to the autogenerated values in `frontend/src/utils/supabase/info.tsx`.

The project also includes `start.sh` which attempts to start both locally. Make sure envs are exported in the shell before running `bash start.sh`.

## Docker-based development (recommended for quick setup)

1. Make sure Docker and Docker Compose are installed.
2. Copy your `backend/.env` into the repo (or create it).
3. Start services:

```bash
docker compose up --build
```

This will:
- Run the backend Deno server on `http://localhost:8000`
- Run the frontend dev server on `http://localhost:5173`

To stop:

```bash
docker compose down
```

## Build frontend for production

```bash
cd frontend
npm run build
# serve the static output via your preferred static server
```

## Ticketing + RBAC setup (admin / organization / technician)

1. Run these migrations in the Supabase SQL editor:
  - `backend/migrations/2025-12-17-add-tickets-and-profiles.sql`
  - `backend/migrations/2025-12-17-add-organization-auth-columns.sql`
  - `backend/migrations/2025-12-17-add-technician-auth-columns.sql`

2. For each Supabase Auth user, create a row in `profiles` to assign a role.

Examples:

```sql
-- Admin (default if no row exists, but explicit is better)
insert into profiles (user_id, role) values ('<auth_user_uuid>', 'admin');

-- Organization user
insert into profiles (user_id, role, organization_id)
values ('<auth_user_uuid>', 'organization', '<organization_uuid>');

-- Technician user
insert into profiles (user_id, role, technician_id)
values ('<auth_user_uuid>', 'technician', '<technician_uuid>');
```

## Organization portal credentials (auto-generated)

When an admin creates an organization via the app, the backend automatically creates an organization login:

- Email: `npa<ORGCODE>@npa.com` (normalized)
- Password: `<ORGCODE_WITHOUT_DASHES>@<orgname>` (sanitized)

The create-organization API response includes:

- `credentials.email`
- `credentials.password` (shown once so copy it)

Admin can manage org login from the Organizations page (key icon):

- View current email
- Update email
- Reset password (returns the new password so copy it)

## Technician portal credentials (auto-generated)

When an admin creates a technician via the app, the backend automatically creates a technician login:

- Email: `techname@npa.com` (derived from technician name; spaces/symbols removed)
- Password: `techname@npa`

Admin can manage technician login from the Technicians page (key icon):

- View/update login email
- Reset password (returns the new password so copy it)

## Troubleshooting
- If the backend returns 401/500, verify your Supabase env variables.
- If `GET/PUT /make-server-60660975/organizations/:id/auth` returns 404, you are almost certainly running an older backend process — restart `start.sh` (or kill port 8000 and start the backend again).
- If ports 8000 or 5173 are in use, either stop the process using them or change the ports in `docker-compose.yml` or `start.sh`.
- Backend loads `backend/.env` automatically (via `jsr:@std/dotenv/load`) when started from the `backend` folder; you can still export envs manually if you prefer.

## Security
- Do not commit `backend/.env` to source control.

---
If you'd like, I can also add a `Makefile` or automate env loading in `start.sh`. Tell me which you'd prefer next.
